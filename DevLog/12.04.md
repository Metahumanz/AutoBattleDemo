# éœ€è¦å®šä¹‰çš„c++ç±»

**â€œæ¥å£å…ˆè¡Œâ€**

æ ¹æ®éœ€æ±‚ï¼ˆæ’å…µå¸ƒé˜µ -> æˆ˜æ–— -> ç»“ç®— -> ä¸‹ä¸€å…³ï¼‰ï¼Œé‡æ–°æ¢³ç†ã€‚


---

### ğŸ›ï¸ å…¬å…±ç±»å‹å®šä¹‰ (Common Types)
å»ºè®®æ–°å»ºä¸€ä¸ªå¤´æ–‡ä»¶ `RTSCoreTypes.h`ï¼Œå­˜æ”¾å¤§å®¶é€šç”¨çš„æšä¸¾å’Œç»“æ„ä½“ï¼Œé¿å…å¾ªç¯å¼•ç”¨ã€‚

```cpp
// RTSCoreTypes.h
#pragma once
#include "CoreMinimal.h"
#include "RTSCoreTypes.generated.h"

// æ¸¸æˆé˜¶æ®µçŠ¶æ€
UENUM(BlueprintType)
enum class EGameState : uint8
{
    Preparation, // å¤‡æˆ˜é˜¶æ®µï¼šç©å®¶ä¹°å…µã€æ‘†é˜µ
    Battle,      // æˆ˜æ–—é˜¶æ®µï¼šè‡ªåŠ¨å¯»è·¯ã€æ”»å‡»
    Victory,     // ç»“ç®—ï¼šèƒœåˆ©
    Defeat       // ç»“ç®—ï¼šå¤±è´¥
};

// é˜Ÿä¼é˜µè¥
UENUM(BlueprintType)
enum class ETeam : uint8
{
    Player,
    Enemy
};

// å…µç§ç±»å‹ï¼ˆç”¨äºå•†åº—è´­ä¹°ï¼‰
UENUM(BlueprintType)
enum class EUnitType : uint8
{
    Soldier, // è¿‘æˆ˜
    Archer,  // è¿œç¨‹
    Tank     // è‚‰ç›¾
};
```

---

### ğŸ—ºï¸ æˆå‘˜ Aï¼šç½‘æ ¼ä¸å¯»è·¯ç³»ç»Ÿ (Grid & Pathfinder)

ä½ çš„ä»»åŠ¡æ˜¯æä¾›ä¸Šå¸è§†è§’çš„åœ°å›¾æ•°æ®ã€‚

#### 1. `GridManager.h` (æ ¸å¿ƒåœ°å›¾ç®¡ç†å™¨)
```cpp
#pragma once
#include "CoreMinimal.h"
#include "GameFramework/Actor.h"
#include "RTSCoreTypes.h"
#include "GridManager.generated.h"

// å®šä¹‰æ ¼å­çš„ç»“æ„ä½“
USTRUCT(BlueprintType)
struct FGridNode
{
    GENERATED_BODY()
    
    // æ ¼å­åæ ‡
    int32 X;
    int32 Y;
    
    // ä¸–ç•Œåæ ‡ä¸­å¿ƒç‚¹
    FVector WorldLocation;
    
    // æ˜¯å¦è¢«é˜»æŒ¡ï¼ˆæœ‰å¢™æˆ–é˜²å¾¡å¡”ï¼‰
    bool bIsBlocked;

    // å¯»è·¯æ¶ˆè€— (å¯ä»¥é¢„ç•™ï¼Œæ¯”å¦‚æ²¼æ³½åœ°èµ°å¾—æ…¢)
    float Cost; 
};

UCLASS()
class AUTOBATTLEDEMO_API AGridManager : public AActor
{
    GENERATED_BODY()
    
public:    
    AGridManager();

    // --- ä¾›æˆå‘˜ C è°ƒç”¨ï¼šåˆå§‹åŒ–åœ°å›¾ ---
    // ç”Ÿæˆå¯è§†åŒ–æ ¼å­ï¼ˆDebugçº¿æˆ–æ¨¡å‹ï¼‰ï¼Œåˆå§‹åŒ– GridArray
    UFUNCTION(BlueprintCallable, Category = "Grid")
    void GenerateGrid(int32 Width, int32 Height, float CellSize);

    // --- ä¾›æˆå‘˜ C è°ƒç”¨ï¼šäº¤äº’è½¬æ¢ ---
    // é¼ æ ‡ç‚¹çš„ä¸–ç•Œåæ ‡ -> æ ¼å­åæ ‡ (ç”¨äºé€ å…µæ—¶å¸é™„ç½‘æ ¼)
    UFUNCTION(BlueprintCallable, Category = "Grid")
    bool WorldToGrid(FVector WorldPos, int32& OutX, int32& OutY);

    // æ ¼å­åæ ‡ -> ä¸–ç•Œåæ ‡ (ç”¨äºæŠŠå…µæ‘†åœ¨æ ¼å­æ­£ä¸­é—´)
    UFUNCTION(BlueprintCallable, Category = "Grid")
    FVector GridToWorld(int32 X, int32 Y);

    // --- ä¾›æˆå‘˜ C è°ƒç”¨ï¼šé˜»æŒ¡è®¾ç½® ---
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½® (ä¸èƒ½é‡å ï¼Œä¹Ÿä¸èƒ½æ”¾åœ¨éšœç¢ç‰©ä¸Š)
    UFUNCTION(BlueprintCallable, Category = "Grid")
    bool IsTileWalkable(int32 X, int32 Y);

    // æ”¾ç½®å»ºç­‘åè°ƒç”¨ï¼Œé”å®šè¯¥æ ¼å­
    UFUNCTION(BlueprintCallable, Category = "Grid")
    void SetTileBlocked(int32 X, int32 Y, bool bBlocked);

    // --- ä¾›æˆå‘˜ B è°ƒç”¨ï¼šæ ¸å¿ƒå¯»è·¯ ---
    // è¾“å…¥ï¼šèµ·ç‚¹ä¸–ç•Œåæ ‡ï¼Œç»ˆç‚¹ä¸–ç•Œåæ ‡
    // è¾“å‡ºï¼šè·¯å¾„ç‚¹åˆ—è¡¨ (World Locations)
    // é‡ç‚¹ï¼šå¦‚æœæ‰¾ä¸åˆ°è·¯å¾„ï¼Œè¿”å›ç©ºæ•°ç»„
    UFUNCTION(BlueprintCallable, Category = "Pathfinding")
    TArray<FVector> FindPath(FVector StartPos, FVector EndPos);

public:
    // äºŒç»´æ•°ç»„æ‰å¹³åŒ–å­˜å‚¨ï¼Œæˆ–è€…ä½¿ç”¨ TArray<FGridNode>
    // å»ºè®®ä½¿ç”¨ TMap<FIntPoint, FGridNode> æˆ–è€…ä¸€ç»´æ•°ç»„ Index = Y * Width + X
    TArray<FGridNode> GridNodes;

    UPROPERTY(EditAnywhere, Category = "Grid Config")
    int32 GridWidthCount;

    UPROPERTY(EditAnywhere, Category = "Grid Config")
    int32 GridHeightCount;

    UPROPERTY(EditAnywhere, Category = "Grid Config")
    float TileSize;
};
```

---

### âš”ï¸ æˆå‘˜ Bï¼šæˆ˜æ–—å•ä½ (Unit & Combat)

ä½ çš„ä»»åŠ¡æ˜¯å®ç°â€œå¬è¯â€çš„å£«å…µå’Œâ€œè¢«æ‰“â€çš„å®ä½“ã€‚

#### 1. `BaseGameEntity.h` (æ‰€æœ‰ç‰©ä½“çš„åŸºç±»)
é˜²å¾¡å¡”å’Œå£«å…µéƒ½ç»§æ‰¿å®ƒï¼Œå› ä¸ºéƒ½æœ‰è¡€æ¡å’Œé˜µè¥ã€‚
```cpp
#pragma once
#include "CoreMinimal.h"
#include "GameFramework/Pawn.h" // ç”¨ Pawn æ¯” Actor å¥½ï¼Œæ–¹ä¾¿æ‰©å±•ç§»åŠ¨
#include "RTSCoreTypes.h"
#include "BaseGameEntity.generated.h"

UCLASS()
class AUTOBATTLEDEMO_API ABaseGameEntity : public APawn
{
    GENERATED_BODY()

public:
    ABaseGameEntity();

    // --- å±æ€§ ---
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Stats")
    float MaxHealth;

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Stats")
    float CurrentHealth;

    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Stats")
    ETeam TeamID; // åŒºåˆ†ç©å®¶è¿˜æ˜¯æ•Œäºº

    // --- æ¥å£ ---
    // å—ä¼¤é€»è¾‘
    virtual float TakeDamage(float DamageAmount, struct FDamageEvent const& DamageEvent, class AController* EventInstigator, AActor* DamageCauser) override;

    // æ­»äº¡é€»è¾‘ï¼ˆä¾› GameMode ç›‘å¬ï¼‰
    virtual void Die();

    // ç”šè‡³å¯ä»¥åŠ ä¸€ä¸ªå§”æ‰˜ï¼Œå½“æ­»äº¡æ—¶é€šçŸ¥ GameMode æ£€æŸ¥èƒœåˆ©æ¡ä»¶
    // FOnEntityDiedSignature OnDeath; 
};
```

#### 2. `BaseUnit.h` (å¯ç§»åŠ¨çš„å£«å…µ)
**æ³¨æ„ï¼š** å› ä¸ºæ²¡æœ‰ NavMeshï¼Œä½ å¿…é¡»åœ¨ `Tick` é‡Œè‡ªå·±å®ç°ç§»åŠ¨ã€‚
```cpp
#pragma once
#include "CoreMinimal.h"
#include "BaseGameEntity.h"
#include "BaseUnit.generated.h"

// å£«å…µçŠ¶æ€æœº
UENUM()
enum class EUnitState : uint8
{
    Idle,       // ç«™æ¡©ï¼ˆå¤‡æˆ˜é˜¶æ®µæˆ–æ— ç›®æ ‡ï¼‰
    Moving,     // æ­£åœ¨æ²¿è·¯å¾„ç§»åŠ¨
    Attacking   // æ”»å‡»ä¸­
};

UCLASS()
class AUTOBATTLEDEMO_API ABaseUnit : public ABaseGameEntity
{
    GENERATED_BODY()
public:
    ABaseUnit();
    virtual void Tick(float DeltaTime) override;

    // --- ä¾› GameMode è°ƒç”¨ ---
    // æ¸¸æˆå¼€å§‹ï¼Œæ¿€æ´»æˆ˜æ–— AI
    UFUNCTION(BlueprintCallable)
    void SetUnitActive(bool bActive);

    // --- å±æ€§ ---
    UPROPERTY(EditAnywhere, Category = "Combat")
    float AttackRange;

    UPROPERTY(EditAnywhere, Category = "Combat")
    float Damage;

    UPROPERTY(EditAnywhere, Category = "Movement")
    float MoveSpeed;

    UPROPERTY(EditAnywhere, Category = "Combat")
    float AttackInterval;

protected:
    // --- æ ¸å¿ƒé€»è¾‘ ---
    // 1. å¯»æ‰¾æœ€è¿‘çš„æ•Œäºº (éå†æ‰€æœ‰ ABaseGameEntity)
    AActor* FindClosestEnemy();

    // 2. è¯·æ±‚è·¯å¾„ (è°ƒç”¨ Member A çš„ GridManager)
    void RequestPathToTarget();

    // 3. æ²¿è·¯å¾„ç§»åŠ¨ (Tick ä¸­æ‰§è¡Œ)
    void MoveAlongPath(float DeltaTime);

    // 4. æ‰§è¡Œæ”»å‡»
    void PerformAttack();

private:
    EUnitState CurrentState;
    
    // ç¼“å­˜å½“å‰çš„è·¯å¾„ç‚¹åˆ—è¡¨
    TArray<FVector> PathPoints;
    int32 CurrentPathIndex;

    // å½“å‰é”å®šçš„ç›®æ ‡
    UPROPERTY()
    AActor* CurrentTarget;

    // æ”»å‡»è®¡æ—¶å™¨
    float LastAttackTime;

    // å¼•ç”¨ GridManager (BeginPlay è·å–)
    class AGridManager* GridManagerRef;
};
```

---

### ğŸ—ï¸ æˆå‘˜ Cï¼šæ¸¸æˆæ§åˆ¶ä¸æµç¨‹ (Game Flow)

ä½ æ˜¯æŠŠ A å’Œ B ä¸²èµ·æ¥çš„äººã€‚

#### 1. `RTSGameInstance.h` (è·¨å…³å¡æ•°æ®)
å› ä¸ºè¦â€œä¸‹ä¸€å¾ªç¯â€ï¼Œé‡‘å¸å¿…é¡»å­˜åœ¨ GameInstance é‡Œï¼Œä¸ç„¶åˆ‡å…³å¡å°±æ²¡äº†ã€‚
```cpp
#pragma once
#include "CoreMinimal.h"
#include "Engine/GameInstance.h"
#include "RTSGameInstance.generated.h"

UCLASS()
class AUTOBATTLEDEMO_API URTSGameInstance : public UGameInstance
{
    GENERATED_BODY()
public:
    // ç©å®¶æŒæœ‰çš„é‡‘å¸ (è·¨å…³å¡ä¿å­˜)
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Player Data")
    int32 PlayerGold;

    // å½“å‰å…³å¡ç´¢å¼• (0, 1, 2)
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Player Data")
    int32 CurrentLevelIndex;
};
```

#### 2. `RTSGameMode.h` (å…³å¡è§„åˆ™è£åˆ¤)
```cpp
#pragma once
#include "CoreMinimal.h"
#include "GameFramework/GameModeBase.h"
#include "RTSCoreTypes.h"
#include "RTSGameMode.generated.h"

UCLASS()
class AUTOBATTLEDEMO_API ARTSGameMode : public AGameModeBase
{
    GENERATED_BODY()
public:
    ARTSGameMode();
    virtual void BeginPlay() override;

    // --- æµç¨‹æ§åˆ¶ API (ä¾› UI è°ƒç”¨) ---
    
    // 1. å°è¯•è´­ä¹°å¹¶æ”¾ç½®å•ä½
    // è¿”å› true è¡¨ç¤ºè´­ä¹°æˆåŠŸï¼Œæ‰£é’±ï¼›è¿”å› false è¡¨ç¤ºé’±ä¸å¤Ÿ
    UFUNCTION(BlueprintCallable, Category = "GameFlow")
    bool TryBuyUnit(EUnitType Type, int32 Cost);

    // 2. ç©å®¶ç‚¹å‡»â€œå¼€å§‹æˆ˜æ–—â€
    UFUNCTION(BlueprintCallable, Category = "GameFlow")
    void StartBattlePhase();

    // 3. é‡æ–°å¼€å§‹æœ¬å…³
    UFUNCTION(BlueprintCallable, Category = "GameFlow")
    void RestartLevel();

    // --- è£åˆ¤é€»è¾‘ ---
    // å•ä½æ­»äº¡æ—¶è°ƒç”¨æ­¤å‡½æ•°
    void OnActorKilled(AActor* Victim, AActor* Killer);

    // æ£€æŸ¥æ˜¯å¦èƒœåˆ© (æ¯å½“æœ‰å•ä½æ­»äº¡æ—¶æ£€æŸ¥)
    void CheckWinCondition();

protected:
    // å½“å‰æ¸¸æˆçŠ¶æ€
    UPROPERTY(BlueprintReadOnly, Category = "GameFlow")
    EGameState CurrentState;

    // å¼•ç”¨ï¼šåœ°å›¾ä¸Šçš„ GridManager
    UPROPERTY()
    class AGridManager* GridManager;

    // é…ç½®ï¼šä¸åŒå…µç§çš„è“å›¾ç±» (ç”¨äº Spawn)
    UPROPERTY(EditDefaultsOnly, Category = "Classes")
    TSubclassOf<class ABaseUnit> SoldierClass;
    
    UPROPERTY(EditDefaultsOnly, Category = "Classes")
    TSubclassOf<class ABaseUnit> ArcherClass;
};
```

#### 3. `RTSPlayerController.h` (æ“ä½œæ‰‹)
è´Ÿè´£å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼ŒæŠŠå…µâ€œç²˜â€åœ¨é¼ æ ‡ä¸Šï¼Œç›´åˆ°ç‚¹ä¸‹ç½‘æ ¼ã€‚
```cpp
#pragma once
#include "CoreMinimal.h"
#include "GameFramework/PlayerController.h"
#include "RTSCoreTypes.h" // å¼•ç”¨æšä¸¾
#include "RTSPlayerController.generated.h"

UCLASS()
class AUTOBATTLEDEMO_API ARTSPlayerController : public APlayerController
{
    GENERATED_BODY()
public:
    ARTSPlayerController();
    virtual void Tick(float DeltaTime) override;

    // --- äº¤äº’é€»è¾‘ ---
    
    // ç©å®¶ç‚¹å‡»äº†UIä¸Šçš„â€œè´­ä¹°æ­¥å…µâ€
    UFUNCTION(BlueprintCallable)
    void OnSelectUnitToPlace(EUnitType UnitType);

    // é¼ æ ‡ç‚¹å‡»å·¦é”® (åœ¨ Blueprint ä¸­ç»‘å®š Input Action: LeftClick)
    UFUNCTION(BlueprintCallable)
    void HandleLeftClick();

private:
    // å½“å‰æ­£åœ¨â€œæ‹–æ‹½/æ‚¬åœâ€å‡†å¤‡æ”¾ç½®çš„å•ä½ç±»å‹
    EUnitType PendingUnitType;
    bool bIsPlacingUnit;

    // ä¸€ä¸ªä¸´æ—¶çš„ Actorï¼Œè·Ÿç€é¼ æ ‡è·‘ï¼Œæ˜¾ç¤ºé¢„è§ˆæ•ˆæœ
    UPROPERTY()
    AActor* PlacementPreviewActor;
};
```

---

### ğŸš€ ç«‹å³æ‰§è¡Œæ­¥éª¤

1.  **ç»„é•¿ (æˆ–ä»»ä½•ä¸€äºº)**ï¼šæ‰“å¼€ VSï¼Œåˆ›å»ºä¸Šè¿°æ‰€æœ‰ `.h` æ–‡ä»¶ã€‚
2.  **å†…å®¹**ï¼šå°†ä»£ç å¤åˆ¶è¿›å»ã€‚
3.  **æäº¤**ï¼š`Git add .` -> `Git commit` -> `Git push`ã€‚
4.  **åˆ†å·¥**ï¼š
    *   **A** å»å†™ `GridManager.cpp`ï¼Œé‡ç‚¹å®ç° `FindPath`ã€‚
    *   **B** å»å†™ `BaseUnit.cpp`ï¼Œé‡ç‚¹å®ç° `Tick` é‡Œçš„ `MoveAlongPath`ã€‚
    *   **C** å»å†™ `RTSGameMode.cpp` å’Œ UI è“å›¾ï¼Œå®ç°é‡‘å¸æ‰£é™¤å’Œå…³å¡åˆ‡æ¢ã€‚

è¿™å¥—æ¥å£å·²ç»å¸®ä½ ä»¬è§£å†³äº†â€œè°è°ƒè°â€çš„é—®é¢˜ï¼š
*   B é‡Œçš„å•ä½åªéœ€è¦è°ƒ `GridManager->FindPath`ã€‚
*   C é‡Œçš„ Controller åªéœ€è¦è°ƒ `GridManager->WorldToGrid`ã€‚
*   å¤§å®¶äº’ä¸å¹²æ‰°ï¼Œå®Œç¾ï¼